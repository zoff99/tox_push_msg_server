---
version: 2

workflows:
  version: 2
  build_linux:
    jobs:
      - build

jobs:
  build:
    working_directory: ~/work
    docker:
      - image: ubuntu:20.04

    steps:
      - run: &apt_install
          apt update &&
          export DEBIAN_FRONTEND=noninteractive ; apt install -y --no-install-recommends
            zip grep file ca-certificates
            git
            ssh gzip tar unzip
            libcurl4-gnutls-dev

      - checkout

      - run: &apt_install
          export DEBIAN_FRONTEND=noninteractive ; apt install -y --no-install-recommends clang-11
      - run: dpkg -l | grep clang
      - run: type -a clang-11
      - run: clang-11 --version


      - run: ls -al
      - run: cp -av fcm_config.h_example fcm_config.h
      - run: clang-11 -O3 -g -fPIC -Wall -Wextra
             -pedantic
             -fno-omit-frame-pointer
             -fsanitize=address
             -fstack-protector-all
             --param=ssp-buffer-size=1
             -Wlarger-than=5000
             -Wframe-larger-than=5000
             -Wvla
             -Werror=div-by-zero
             -Wpointer-arith
             -Wimplicit-fallthrough
             -Werror=implicit-function-declaration
             -Wformat=0
             -Wno-misleading-indentation
             -Werror
             -fdiagnostics-color=always
             tox_push_msg_server.c
             -lcurl
             -o tox_push_msg_server

      - run: ldd tox_push_msg_server
      - run: ls -al tox_push_msg_server

      - store_artifacts:
          path: ~/work/tox_push_msg_server
          destination: tox_push_msg_server.amd64.linux
